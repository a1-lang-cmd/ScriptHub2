-- ================================
-- üîê ScriptHub Key System (Executor)
-- More-compatible HTTP + HWID (Synapse, Xeno, etc.)
-- ================================

local Player = game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- Use your own ngrok / HTTPS URL here
local Server_URL = "https://heterocyclic-tomika-interfemoral.ngrok-free.dev"

-- =========================
-- Supported games (for non-admin keys)
-- =========================
-- Admin keys can run anywhere; regular keys only in these games.
local SUPPORTED_GAMES = {
    [168556275] = {
        Name = "Baseplate",
        Description = "Example sandbox for ScriptHub.",
        LoadString = "loadstring(game:HttpGet('https://rawscripts.net/raw/Universal-Script-Infinite-Yield-43437'))()",
    },
    [2317185366] = {
        Name = "Unwavering Soul",
        Description = "Based on Undertale by Toby",
        LoadString = "loadstring(game:HttpGet('https://raw.githubusercontent.com/UnstableScriptPoster/THE-HACK-/main/script%20omg'))()",
    },
    [109983668079237] = {
        Name = "Steal a Brainrot",
        Description = "Steal a brainrot free script.",
        LoadString = "loadstring(game:HttpGet('https://raw.githubusercontent.com/tienkhanh1/spicy/main/Chilli.lua'))()",
    },
}


local function IsSupportedGame()
    return SUPPORTED_GAMES[game.PlaceId] ~= nil
end

-- =========================
-- HTTP request resolver
-- =========================
local request = nil

if syn and type(syn.request) == "function" then
    request = syn.request
elseif typeof(request) == "function" then
    request = request
elseif typeof(http_request) == "function" then
    request = http_request
elseif typeof(Fluxus) == "table" and typeof(Fluxus.request) == "function" then
    request = Fluxus.request
elseif typeof(krnl_request) == "function" then
    request = krnl_request
elseif typeof(Xeno) == "table" and typeof(Xeno.request) == "function" then
    request = Xeno.request
end

-- =========================
-- HWID Detection
-- =========================
local function GetHWID()
    if typeof(gethwid) == "function" then
        return gethwid()
    end

    if syn and typeof(syn.request) == "function" then
        return tostring(Player.UserId) .. "_syn"
    end

    return string.format(
        "%s_%s_%s",
        tostring(Player.UserId),
        tostring(game.PlaceId),
        tostring(game.JobId)
    )
end

local HWID = GetHWID()

-- =========================
-- HTTP Helpers
-- =========================
local function DoJSONRequest(method, url, bodyTable)
    if not request then
        warn("‚ö†Ô∏è No HTTP request function available in this executor.")
        return nil
    end

    local options = {
        Url = url,
        Method = method,
        Headers = {
            ["Content-Type"] = "application/json"
        }
    }

    if bodyTable then
        options.Body = HttpService:JSONEncode(bodyTable)
    end

    local ok, res = pcall(function()
        return request(options)
    end)

    if not ok or not res or not res.Body then
        warn("‚ùå HTTP error:", ok and res.StatusCode, res and res.Body)
        return nil
    end

    return res
end

local function DoRequest(url)
    return DoJSONRequest("GET", url, nil)
end

-- =========================
-- API Functions (Discord bot)
-- =========================
local function CheckActiveKey()
    local url = Server_URL .. "/active?hwid=" .. HttpService:UrlEncode(HWID)
    local response = DoRequest(url)
    if not response or response.StatusCode ~= 200 then
        return false, nil, false
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data then
        return false, nil, false
    end

    if data.active then
        return true, data.keyType, data.admin or false
    end

    return false, nil, false
end

local function VerifyKey(key)
    local url = Server_URL .. "/verify/" .. key .. "?hwid=" .. HttpService:UrlEncode(HWID)
    local response = DoRequest(url)
    if not response or response.StatusCode ~= 200 then
        return false, "Connection error", false
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data then
        return false, "Invalid response", false
    end

    if data.valid then
        return true, data.message or "Key verified", data.admin or false
    end

    return false, data.message or "Invalid key", false
end

local function GetAllStats()
    local url = Server_URL .. "/stats"
    local response = DoRequest(url)
    if not response or response.StatusCode ~= 200 then
        return nil
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data or not data.stats then
        return nil
    end

    return data.stats
end

local function GetDetailedKeys()
    local url = Server_URL .. "/admin/keys"
    local response = DoRequest(url)
    if not response or response.StatusCode ~= 200 then
        return nil
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data or not data.keys then
        return nil
    end

    return data.keys
end

local function PatchKeyConfig(keyString, configTable)
    local url = Server_URL .. "/admin/keys/" .. HttpService:UrlEncode(keyString)
    local response = DoJSONRequest("PATCH", url, configTable)
    if not response or response.StatusCode ~= 200 then
        return false, "HTTP " .. tostring(response and response.StatusCode or "ERR")
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data or not data.success then
        return false, "Update failed"
    end

    return true, "Updated"
end

local function DeleteKey(keyString)
    local url = Server_URL .. "/admin/keys/" .. HttpService:UrlEncode(keyString)
    local response = DoJSONRequest("DELETE", url, nil)
    if not response then
        return false, "No response"
    end
    if response.StatusCode == 404 then
        return false, "Key not found"
    end
    if response.StatusCode ~= 200 then
        return false, "HTTP " .. tostring(response.StatusCode)
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response.Body)
    end)
    if not ok or not data or not data.success then
        return false, "Delete failed"
    end

    return true, "Deleted"
end

-- =========================
-- Admin Panel UI (unchanged layout)
-- =========================
local function CreateAdminPanel()
    print("üöÄ Creating Admin Panel...")

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AdminPanel_" .. math.random(10000, 99999)
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game:GetService("CoreGui")

    local Panel = Instance.new("Frame")
    Panel.Position = UDim2.new(0.5, -400, 0.5, -300)
    Panel.Size = UDim2.new(0, 800, 0, 600)
    Panel.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    Panel.BorderSizePixel = 0
    Panel.Parent = ScreenGui

    local PanelCorner = Instance.new("UICorner")
    PanelCorner.CornerRadius = UDim.new(0, 12)
    PanelCorner.Parent = Panel

    local PanelStroke = Instance.new("UIStroke")
    PanelStroke.Color = Color3.fromRGB(88, 101, 242)
    PanelStroke.Thickness = 2
    PanelStroke.Parent = Panel

    -- Dragging
    local dragging = false
    local dragStart
    local startPos

    local TopBar = Instance.new("Frame")
    TopBar.Size = UDim2.new(1, 0, 0, 50)
    TopBar.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    TopBar.BorderSizePixel = 0
    TopBar.Parent = Panel

    local TopBarCorner = Instance.new("UICorner")
    TopBarCorner.CornerRadius = UDim.new(0, 12)
    TopBarCorner.Parent = TopBar

    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Panel.Position
        end
    end)

    TopBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Panel.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    local Title = Instance.new("TextLabel")
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.Size = UDim2.new(0, 400, 1, 0)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.Text = "üõ°Ô∏è Admin Control Panel - Key Manager"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 20
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TopBar

    -- Minimize
    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.AnchorPoint = Vector2.new(1, 0.5)
    MinimizeButton.Position = UDim2.new(1, -60, 0.5, 0)
    MinimizeButton.Size = UDim2.new(0, 35, 0, 35)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
    MinimizeButton.BorderSizePixel = 0
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.Text = "‚àí"
    MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeButton.TextSize = 20
    MinimizeButton.Parent = TopBar

    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim.new(0, 8)
    MinimizeCorner.Parent = MinimizeButton

    -- Close
    local CloseButton = Instance.new("TextButton")
    CloseButton.AnchorPoint = Vector2.new(1, 0.5)
    CloseButton.Position = UDim2.new(1, -15, 0.5, 0)
    CloseButton.Size = UDim2.new(0, 35, 0, 35)
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    CloseButton.BorderSizePixel = 0
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Text = "‚úï"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 18
    CloseButton.Parent = TopBar

    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 8)
    CloseCorner.Parent = CloseButton

    -- Stats container
    local StatsContainer = Instance.new("Frame")
    StatsContainer.Position = UDim2.new(0, 15, 0, 65)
    StatsContainer.Size = UDim2.new(1, -30, 0, 80)
    StatsContainer.BackgroundTransparency = 1
    StatsContainer.Parent = Panel

    local statTypes = {
        {name = "Total Keys", color = Color3.fromRGB(88, 101, 242), key = "total"},
        {name = "Active Keys", color = Color3.fromRGB(50, 200, 100), key = "active"},
        {name = "Permanent",  color = Color3.fromRGB(138, 43, 226), key = "permanent"},
        {name = "Temporary",  color = Color3.fromRGB(255, 165, 0), key = "temporary"},
        {name = "Admin Keys", color = Color3.fromRGB(255, 215, 0), key = "admin"},
    }

    local statLabels = {}

    for i, stat in ipairs(statTypes) do
        local Card = Instance.new("Frame")
        Card.Position = UDim2.new((i - 1) * 0.2, 0, 0, 0)
        Card.Size = UDim2.new(0.18, 0, 1, 0)
        Card.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Card.BorderSizePixel = 0
        Card.Parent = StatsContainer

        local CardCorner = Instance.new("UICorner")
        CardCorner.CornerRadius = UDim.new(0, 8)
        CardCorner.Parent = Card

        local CardAccent = Instance.new("Frame")
        CardAccent.Size = UDim2.new(1, 0, 0, 3)
        CardAccent.BackgroundColor3 = stat.color
        CardAccent.BorderSizePixel = 0
        CardAccent.Parent = Card

        local StatName = Instance.new("TextLabel")
        StatName.Position = UDim2.new(0, 0, 0, 8)
        StatName.Size = UDim2.new(1, 0, 0, 18)
        StatName.BackgroundTransparency = 1
        StatName.Font = Enum.Font.Gotham
        StatName.Text = stat.name
        StatName.TextColor3 = Color3.fromRGB(150, 150, 165)
        StatName.TextSize = 11
        StatName.Parent = Card

        local StatValue = Instance.new("TextLabel")
        StatValue.Position = UDim2.new(0, 0, 0, 30)
        StatValue.Size = UDim2.new(1, 0, 0, 35)
        StatValue.BackgroundTransparency = 1
        StatValue.Font = Enum.Font.GothamBold
        StatValue.Text = "0"
        StatValue.TextColor3 = Color3.fromRGB(255, 255, 255)
        StatValue.TextSize = 24
        StatValue.Parent = Card

        statLabels[stat.key] = StatValue
    end

    -- Keys list
    local ListContainer = Instance.new("ScrollingFrame")
    ListContainer.Position = UDim2.new(0, 15, 0, 160)
    ListContainer.Size = UDim2.new(1, -30, 1, -220)
    ListContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    ListContainer.BorderSizePixel = 0
    ListContainer.ScrollBarThickness = 6
    ListContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    ListContainer.Parent = Panel

    local ListCorner = Instance.new("UICorner")
    ListCorner.CornerRadius = UDim.new(0, 8)
    ListCorner.Parent = ListContainer

    local ListLayout = Instance.new("UIListLayout")
    ListLayout.Padding = UDim.new(0, 8)
    ListLayout.Parent = ListContainer

    ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        ListContainer.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
    end)

    -- Buttons / status
    local RefreshButton = Instance.new("TextButton")
    RefreshButton.Position = UDim2.new(0, 15, 1, -45)
    RefreshButton.Size = UDim2.new(0, 150, 0, 35)
    RefreshButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    RefreshButton.BorderSizePixel = 0
    RefreshButton.Font = Enum.Font.GothamBold
    RefreshButton.Text = "üîÑ Refresh Data"
    RefreshButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    RefreshButton.TextSize = 14
    RefreshButton.Parent = Panel

    local RefreshCorner = Instance.new("UICorner")
    RefreshCorner.CornerRadius = UDim.new(0, 8)
    RefreshCorner.Parent = RefreshButton

    local AutoRefreshButton = Instance.new("TextButton")
    AutoRefreshButton.Position = UDim2.new(0, 175, 1, -45)
    AutoRefreshButton.Size = UDim2.new(0, 180, 0, 35)
    AutoRefreshButton.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    AutoRefreshButton.BorderSizePixel = 0
    AutoRefreshButton.Font = Enum.Font.GothamBold
    AutoRefreshButton.Text = "‚è±Ô∏è Auto-Refresh: OFF"
    AutoRefreshButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    AutoRefreshButton.TextSize = 14
    AutoRefreshButton.Parent = Panel

    local AutoRefreshCorner = Instance.new("UICorner")
    AutoRefreshCorner.CornerRadius = UDim.new(0, 8)
    AutoRefreshCorner.Parent = AutoRefreshButton

    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Position = UDim2.new(1, -250, 1, -45)
    StatusLabel.Size = UDim2.new(0, 235, 0, 35)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Font = Enum.Font.GothamMedium
    StatusLabel.Text = "üü¢ Connected"
    StatusLabel.TextColor3 = Color3.fromRGB(50, 200, 100)
    StatusLabel.TextSize = 13
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Right
    StatusLabel.Parent = Panel

    -- (Key cards / UpdateStats / UpdateKeyList / auto-refresh / close / entrance)
    -- keep your existing implementations here (omitted for brevity)
    -- ...

    -- Simple minimize: hide body instead of collapsing content
    local ContentHolder = Instance.new("Frame")
    ContentHolder.Name = "ContentHolder"
    ContentHolder.BackgroundTransparency = 1
    ContentHolder.Size = UDim2.new(1, 0, 1, -50)
    ContentHolder.Position = UDim2.new(0, 0, 0, 50)
    ContentHolder.Parent = Panel

    -- move these into ContentHolder:
    StatsContainer.Parent = ContentHolder
    ListContainer.Parent = ContentHolder
    RefreshButton.Parent = ContentHolder
    AutoRefreshButton.Parent = ContentHolder
    StatusLabel.Parent = ContentHolder

    local isMinimized = false
    local originalSize = Panel.Size

    MinimizeButton.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        if isMinimized then
            ContentHolder.Visible = false
            TweenService:Create(Panel, TweenInfo.new(0.25, Enum.EasingStyle.Quad), {
                Size = UDim2.new(0, 800, 0, 50)
            }):Play()
            MinimizeButton.Text = "‚ñ°"
        else
            TweenService:Create(Panel, TweenInfo.new(0.25, Enum.EasingStyle.Quad), {
                Size = originalSize
            }):Play()
            ContentHolder.Visible = true
            MinimizeButton.Text = "‚àí"
        end
    end)

    CloseButton.MouseButton1Click:Connect(function()
        local closeTween = TweenService:Create(Panel, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0)
        })
        closeTween:Play()
        closeTween.Completed:Wait()
        ScreenGui:Destroy()
    end)

    -- entrance
    Panel.Size = UDim2.new(0, 0, 0, 0)
    Panel.AnchorPoint = Vector2.new(0.5, 0.5)
    Panel.Position = UDim2.new(0.5, 0, 0.5, 0)

    TweenService:Create(Panel, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = originalSize
    }):Play()

    Panel.AnchorPoint = Vector2.new(0, 0)
    Panel.Position = UDim2.new(0.5, -400, 0.5, -300)

    -- you should reattach UpdateStats/UpdateKeyList calls here
end

-- =========================
-- ScriptHub main UI (regular users)
-- =========================
local function CreateScriptHubUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "ScriptHub_UI_" .. math.random(10000, 99999)
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game:GetService("CoreGui")

    -- services / locals needed for visuals
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local LocalPlayer = Players.LocalPlayer

    -- visuals configurable settings
    local highlightColor = Color3.fromRGB(130, 255, 130)
    local highlightFillTransparency = 0.75
    local highlightOutlineTransparency = 0
    local nameColor = Color3.fromRGB(130, 255, 130)

    local function sliderToColor(r, g, b)
        return Color3.fromRGB(r, g, b)
    end

    local function makeSliderRow(parent, yOffset, labelText, defaultValue, onChanged)
        local Row = Instance.new("Frame")
        Row.Position = UDim2.new(0, 8, 0, yOffset)
        Row.Size = UDim2.new(0.55, -16, 0, 26)
        Row.BackgroundTransparency = 1
        Row.Parent = parent

        local Label = Instance.new("TextLabel")
        Label.Size = UDim2.new(0.55, 0, 1, 0)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.Gotham
        Label.Text = labelText .. " (" .. tostring(defaultValue) .. ")"
        Label.TextColor3 = Color3.fromRGB(200, 200, 210)
        Label.TextSize = 12
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Parent = Row

        local Box = Instance.new("TextBox")
        Box.Position = UDim2.new(0.55, 4, 0, 0)
        Box.Size = UDim2.new(0.45, -4, 1, 0)
        Box.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
        Box.BorderSizePixel = 0
        Box.Font = Enum.Font.Gotham
        Box.PlaceholderText = tostring(defaultValue)
        Box.Text = tostring(defaultValue)
        Box.TextColor3 = Color3.fromRGB(230, 230, 240)
        Box.TextSize = 12
        Box.ClearTextOnFocus = false
        Box.Parent = Row

        local BoxCorner = Instance.new("UICorner")
        BoxCorner.CornerRadius = UDim.new(0, 6)
        BoxCorner.Parent = Box

        Box.FocusLost:Connect(function()
            local num = tonumber(Box.Text)
            if not num then
                Box.Text = tostring(defaultValue)
                num = defaultValue
            end
            num = math.clamp(math.floor(num + 0.5), 0, 255)
            Box.Text = tostring(num)
            Label.Text = labelText .. " (" .. tostring(num) .. ")"
            if onChanged then
                onChanged(num)
            end
        end)

        return Row
    end

    local function makeAlphaRow(parent, yOffset, labelText, defaultPercent, onChangedAlpha)
        local Row = Instance.new("Frame")
        Row.Position = UDim2.new(0, 8, 0, yOffset)
        Row.Size = UDim2.new(0.55, -16, 0, 26)
        Row.BackgroundTransparency = 1
        Row.Parent = parent

        local Label = Instance.new("TextLabel")
        Label.Size = UDim2.new(0.55, 0, 1, 0)
        Label.BackgroundTransparency = 1
        Label.Font = Enum.Font.Gotham
        Label.Text = labelText .. " (" .. tostring(defaultPercent) .. "%)"
        Label.TextColor3 = Color3.fromRGB(200, 200, 210)
        Label.TextSize = 12
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Parent = Row

        local Box = Instance.new("TextBox")
        Box.Position = UDim2.new(0.55, 4, 0, 0)
        Box.Size = UDim2.new(0.45, -4, 1, 0)
        Box.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
        Box.BorderSizePixel = 0
        Box.Font = Enum.Font.Gotham
        Box.PlaceholderText = tostring(defaultPercent)
        Box.Text = tostring(defaultPercent)
        Box.TextColor3 = Color3.fromRGB(230, 230, 240)
        Box.TextSize = 12
        Box.ClearTextOnFocus = false
        Box.Parent = Row

        local BoxCorner = Instance.new("UICorner")
        BoxCorner.CornerRadius = UDim.new(0, 6)
        BoxCorner.Parent = Box

        Box.FocusLost:Connect(function()
            local num = tonumber(Box.Text)
            if not num then
                Box.Text = tostring(defaultPercent)
                num = defaultPercent
            end
            num = math.clamp(math.floor(num + 0.5), 0, 100)
            Box.Text = tostring(num)
            Label.Text = labelText .. " (" .. tostring(num) .. "%)"
            local alpha = num / 100
            if onChangedAlpha then
                onChangedAlpha(alpha)
            end
        end)
    end

    -- main window
    local Window = Instance.new("Frame")
    Window.Size = UDim2.new(0, 900, 0, 520)
    Window.Position = UDim2.new(0.5, -450, 0.5, -260)
    Window.BackgroundColor3 = Color3.fromRGB(12, 12, 14)
    Window.BorderSizePixel = 0
    Window.Active = true
    Window.Parent = ScreenGui

    local WindowCorner = Instance.new("UICorner")
    WindowCorner.CornerRadius = UDim.new(0, 12)
    WindowCorner.Parent = Window

    -- top bar for dragging + controls
    local TopBar = Instance.new("Frame")
    TopBar.Size = UDim2.new(1, 0, 0, 36)
    TopBar.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
    TopBar.BorderSizePixel = 0
    TopBar.Parent = Window
    TopBar.Active = true

    local TopBarCorner = Instance.new("UICorner")
    TopBarCorner.CornerRadius = UDim.new(0, 12)
    TopBarCorner.Parent = TopBar

    local dragging = false
    local dragStart, startPos

    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Window.Position
        end
    end)

    TopBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Window.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    local TopTitle = Instance.new("TextLabel")
    TopTitle.Position = UDim2.new(0, 12, 0, 0)
    TopTitle.Size = UDim2.new(1, -120, 1, 0)
    TopTitle.BackgroundTransparency = 1
    TopTitle.Font = Enum.Font.GothamBold
    TopTitle.Text = "ScriptHub"
    TopTitle.TextColor3 = Color3.fromRGB(235, 235, 235)
    TopTitle.TextSize = 16
    TopTitle.TextXAlignment = Enum.TextXAlignment.Left
    TopTitle.Parent = TopBar

    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.AnchorPoint = Vector2.new(1, 0.5)
    MinimizeButton.Position = UDim2.new(1, -40, 0.5, 0)
    MinimizeButton.Size = UDim2.new(0, 28, 0, 20)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
    MinimizeButton.BorderSizePixel = 0
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.Text = "‚Äì"
    MinimizeButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    MinimizeButton.TextSize = 16
    MinimizeButton.Parent = TopBar

    local MinCorner = Instance.new("UICorner")
    MinCorner.CornerRadius = UDim.new(0, 6)
    MinCorner.Parent = MinimizeButton

    local CloseButton = Instance.new("TextButton")
    CloseButton.AnchorPoint = Vector2.new(1, 0.5)
    CloseButton.Position = UDim2.new(1, -8, 0.5, 0)
    CloseButton.Size = UDim2.new(0, 28, 0, 20)
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    CloseButton.BorderSizePixel = 0
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    CloseButton.Parent = TopBar

    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 6)
    CloseCorner.Parent = CloseButton

    local ContentHolder = Instance.new("Frame")
    ContentHolder.Position = UDim2.new(0, 0, 0, 36)
    ContentHolder.Size = UDim2.new(1, 0, 1, -36)
    ContentHolder.BackgroundTransparency = 1
    ContentHolder.Parent = Window

    local Resizer = Instance.new("Frame")
    Resizer.Size = UDim2.new(0, 16, 0, 16)
    Resizer.AnchorPoint = Vector2.new(1, 1)
    Resizer.Position = UDim2.new(1, -4, 1, -4)
    Resizer.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    Resizer.BorderSizePixel = 0
    Resizer.Active = true
    Resizer.Parent = Window

    local ResizerCorner = Instance.new("UICorner")
    ResizerCorner.CornerRadius = UDim.new(0, 4)
    ResizerCorner.Parent = Resizer

    local resizing = false
    local resizeStartPos, resizeStartSize

    Resizer.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            resizing = true
            resizeStartPos = input.Position
            resizeStartSize = Window.Size
        end
    end)

    Resizer.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            resizing = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if resizing and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - resizeStartPos
            local newW = math.max(600, resizeStartSize.X.Offset + delta.X)
            local newH = math.max(360, resizeStartSize.Y.Offset + delta.Y)
            Window.Size = UDim2.new(0, newW, 0, newH)
        end
    end)

    local Sidebar = Instance.new("Frame")
    Sidebar.Size = UDim2.new(0, 200, 1, 0)
    Sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 12)
    Sidebar.BorderSizePixel = 0
    Sidebar.Parent = ContentHolder

    local SidebarCorner = Instance.new("UICorner")
    SidebarCorner.CornerRadius = UDim.new(0, 12)
    SidebarCorner.Parent = Sidebar

    local HubTitle = Instance.new("TextLabel")
    HubTitle.Position = UDim2.new(0, 16, 0, 12)
    HubTitle.Size = UDim2.new(1, -32, 0, 26)
    HubTitle.BackgroundTransparency = 1
    HubTitle.Font = Enum.Font.GothamBold
    HubTitle.Text = "ScriptHub"
    HubTitle.TextColor3 = Color3.fromRGB(235, 235, 235)
    HubTitle.TextSize = 20
    HubTitle.TextXAlignment = Enum.TextXAlignment.Left
    HubTitle.Parent = Sidebar

    local Accent = Instance.new("Frame")
    Accent.Position = UDim2.new(0, 16, 0, 40)
    Accent.Size = UDim2.new(0, 60, 0, 2)
    Accent.BackgroundColor3 = Color3.fromRGB(130, 255, 130)
    Accent.BorderSizePixel = 0
    Accent.Parent = Sidebar

    local TabsContainer = Instance.new("Frame")
    TabsContainer.Position = UDim2.new(0, 0, 0, 70)
    TabsContainer.Size = UDim2.new(1, 0, 1, -70)
    TabsContainer.BackgroundTransparency = 1
    TabsContainer.Parent = Sidebar

    local TabsList = Instance.new("UIListLayout")
    TabsList.SortOrder = Enum.SortOrder.LayoutOrder
    TabsList.Padding = UDim.new(0, 4)
    TabsList.Parent = TabsContainer

    local function CreateTabButton(text, icon)
        local Button = Instance.new("TextButton")
        Button.Size = UDim2.new(1, 0, 0, 32)
        Button.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
        Button.BorderSizePixel = 0
        Button.AutoButtonColor = false
        Button.Font = Enum.Font.Gotham
        Button.Text = ""
        Button.Parent = TabsContainer

        local IconLabel = Instance.new("TextLabel")
        IconLabel.Size = UDim2.new(0, 28, 1, 0)
        IconLabel.BackgroundTransparency = 1
        IconLabel.Font = Enum.Font.Gotham
        IconLabel.Text = icon or "‚Ä¢"
        IconLabel.TextColor3 = Color3.fromRGB(130, 255, 130)
        IconLabel.TextSize = 18
        IconLabel.Parent = Button

        local TextLabel = Instance.new("TextLabel")
        TextLabel.Position = UDim2.new(0, 30, 0, 0)
        TextLabel.Size = UDim2.new(1, -34, 1, 0)
        TextLabel.BackgroundTransparency = 1
        TextLabel.Font = Enum.Font.Gotham
        TextLabel.Text = text
        TextLabel.TextColor3 = Color3.fromRGB(200, 200, 210)
        TextLabel.TextSize = 14
        TextLabel.TextXAlignment = Enum.TextXAlignment.Left
        TextLabel.Parent = Button

        local Corner = Instance.new("UICorner")
        Corner.CornerRadius = UDim.new(0, 6)
        Corner.Parent = Button

        return Button, TextLabel
    end

    local Tabs = {}
    Tabs.Loader, _ = CreateTabButton("Loader", "üìÇ")
    Tabs.Combat, _ = CreateTabButton("Combat", "üéØ")
    Tabs.Visuals, _ = CreateTabButton("Visuals", "üé®")
    Tabs.Misc, _ = CreateTabButton("Misc", "‚öôÔ∏è")

    local Content = Instance.new("Frame")
    Content.Position = UDim2.new(0, 210, 0, 10)
    Content.Size = UDim2.new(1, -220, 1, -20)
    Content.BackgroundColor3 = Color3.fromRGB(15, 15, 18)
    Content.BorderSizePixel = 0
    Content.Parent = ContentHolder

    local ContentCorner = Instance.new("UICorner")
    ContentCorner.CornerRadius = UDim.new(0, 12)
    ContentCorner.Parent = Content

    local Pages = {}

    local function CreatePage()
        local Page = Instance.new("Frame")
        Page.Size = UDim2.new(1, -20, 1, -20)
        Page.Position = UDim2.new(0, 10, 0, 10)
        Page.BackgroundTransparency = 1
        Page.Visible = false
        Page.Parent = Content
        return Page
    end

    local function SwitchTo(pageName)
        for name, page in pairs(Pages) do
            page.Visible = (name == pageName)
        end
        for _, btn in pairs(Tabs) do
            TweenService:Create(btn, TweenInfo.new(0.15), {
                BackgroundColor3 = Color3.fromRGB(18, 18, 22)
            }):Play()
        end
        TweenService:Create(Tabs[pageName], TweenInfo.new(0.15), {
            BackgroundColor3 = Color3.fromRGB(25, 25, 30)
        }):Play()
    end

    -- Loader page
    Pages.Loader = CreatePage()

    local LoaderTitle = Instance.new("TextLabel")
    LoaderTitle.Position = UDim2.new(0, 8, 0, 4)
    LoaderTitle.Size = UDim2.new(1, -16, 0, 26)
    LoaderTitle.BackgroundTransparency = 1
    LoaderTitle.Font = Enum.Font.GothamBold
    LoaderTitle.Text = "Game Loader"
    LoaderTitle.TextColor3 = Color3.fromRGB(230, 230, 240)
    LoaderTitle.TextSize = 20
    LoaderTitle.TextXAlignment = Enum.TextXAlignment.Left
    LoaderTitle.Parent = Pages.Loader

    local SearchBox = Instance.new("TextBox")
    SearchBox.Position = UDim2.new(0, 8, 0, 30)
    SearchBox.Size = UDim2.new(0.6, -16, 0, 24)
    SearchBox.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
    SearchBox.BorderSizePixel = 0
    SearchBox.Font = Enum.Font.Gotham
    SearchBox.PlaceholderText = "Search games..."
    SearchBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 135)
    SearchBox.Text = ""
    SearchBox.TextColor3 = Color3.fromRGB(230, 230, 240)
    SearchBox.TextSize = 13
    SearchBox.TextXAlignment = Enum.TextXAlignment.Left
    SearchBox.Parent = Pages.Loader

    local SearchCorner = Instance.new("UICorner")
    SearchCorner.CornerRadius = UDim.new(0, 6)
    SearchCorner.Parent = SearchBox

    local SearchButton = Instance.new("TextButton")
    SearchButton.Position = UDim2.new(0.6, 4, 0, 30)
    SearchButton.Size = UDim2.new(0, 90, 0, 24)
    SearchButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    SearchButton.BorderSizePixel = 0
    SearchButton.Font = Enum.Font.GothamBold
    SearchButton.Text = "Search"
    SearchButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    SearchButton.TextSize = 13
    SearchButton.Parent = Pages.Loader

    local SearchBtnCorner = Instance.new("UICorner")
    SearchBtnCorner.CornerRadius = UDim.new(0, 6)
    SearchBtnCorner.Parent = SearchButton

    local LoaderSub = Instance.new("TextLabel")
    LoaderSub.Position = UDim2.new(0, 8, 0, 58)
    LoaderSub.Size = UDim2.new(1, -16, 0, 18)
    LoaderSub.BackgroundTransparency = 1
    LoaderSub.Font = Enum.Font.Gotham
    LoaderSub.Text = "Choose a game to auto-inject its script."
    LoaderSub.TextColor3 = Color3.fromRGB(150, 150, 165)
    LoaderSub.TextSize = 13
    LoaderSub.TextXAlignment = Enum.TextXAlignment.Left
    LoaderSub.Parent = Pages.Loader

    local GameList = Instance.new("ScrollingFrame")
    GameList.Position = UDim2.new(0, 8, 0, 80)
    GameList.Size = UDim2.new(1, -16, 1, -88)
    GameList.BackgroundTransparency = 1
    GameList.BorderSizePixel = 0
    GameList.CanvasSize = UDim2.new(0, 0, 0, 0)
    GameList.ScrollBarThickness = 4
    GameList.Parent = Pages.Loader

    local GameLayout = Instance.new("UIListLayout")
    GameLayout.Padding = UDim.new(0, 8)
    GameLayout.SortOrder = Enum.SortOrder.LayoutOrder
    GameLayout.Parent = GameList

    GameLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        GameList.CanvasSize = UDim2.new(0, 0, 0, GameLayout.AbsoluteContentSize.Y + 8)
    end)

    local function CreateGameCard(placeId, info)
        local Card = Instance.new("Frame")
        Card.Size = UDim2.new(1, -4, 0, 70)
        Card.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
        Card.BorderSizePixel = 0
        Card.Parent = GameList

        local CardCorner = Instance.new("UICorner")
        CardCorner.CornerRadius = UDim.new(0, 10)
        CardCorner.Parent = Card

        local AccentBar = Instance.new("Frame")
        AccentBar.Position = UDim2.new(0, 0, 0, 0)
        AccentBar.Size = UDim2.new(0, 4, 1, 0)
        AccentBar.BackgroundColor3 = Color3.fromRGB(130, 255, 130)
        AccentBar.BorderSizePixel = 0
        AccentBar.Parent = Card

        local NameLabel = Instance.new("TextLabel")
        NameLabel.Position = UDim2.new(0, 12, 0, 8)
        NameLabel.Size = UDim2.new(1, -130, 0, 20)
        NameLabel.BackgroundTransparency = 1
        NameLabel.Font = Enum.Font.GothamBold
        NameLabel.Text = info.Name .. "  (" .. placeId .. ")"
        NameLabel.TextColor3 = Color3.fromRGB(235, 235, 240)
        NameLabel.TextSize = 15
        NameLabel.TextXAlignment = Enum.TextXAlignment.Left
        NameLabel.Parent = Card

        local DescLabel = Instance.new("TextLabel")
        DescLabel.Position = UDim2.new(0, 12, 0, 32)
        DescLabel.Size = UDim2.new(1, -130, 0, 18)
        DescLabel.BackgroundTransparency = 1
        DescLabel.Font = Enum.Font.Gotham
        DescLabel.Text = info.Description or "No description."
        DescLabel.TextColor3 = Color3.fromRGB(160, 160, 175)
        DescLabel.TextSize = 12
        DescLabel.TextXAlignment = Enum.TextXAlignment.Left
        DescLabel.Parent = Card

        local LoadButton = Instance.new("TextButton")
        LoadButton.AnchorPoint = Vector2.new(1, 0.5)
        LoadButton.Position = UDim2.new(1, -12, 0.5, 0)
        LoadButton.Size = UDim2.new(0, 110, 0, 32)
        LoadButton.BackgroundColor3 = Color3.fromRGB(130, 255, 130)
        LoadButton.BorderSizePixel = 0
        LoadButton.Font = Enum.Font.GothamBold
        LoadButton.Text = "Load Script"
        LoadButton.TextColor3 = Color3.fromRGB(15, 20, 15)
        LoadButton.TextSize = 14
        LoadButton.Parent = Card

        local LoadCorner = Instance.new("UICorner")
        LoadCorner.CornerRadius = UDim.new(0, 8)
        LoadCorner.Parent = LoadButton

        LoadButton.MouseButton1Click:Connect(function()
            if type(info.LoadString) == "string" and info.LoadString ~= "" then
                print("[ScriptHub] Executing loader for:", info.Name, "placeId:", placeId)
                local ok, err = pcall(function()
                    loadstring(info.LoadString)()
                end)
                if not ok then
                    warn("Loader error for", info.Name, ":", err)
                end
            else
                warn("No LoadString configured for", info.Name)
            end
        end)
    end

    local function RefreshGameList(filter)
        filter = (filter or ""):lower()
        for _, child in ipairs(GameList:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
        for placeId, info in pairs(SUPPORTED_GAMES) do
            local name = tostring(info.Name or ""):lower()
            local desc = tostring(info.Description or ""):lower()
            if filter == "" or name:find(filter, 1, true) or desc:find(filter, 1, true) then
                CreateGameCard(placeId, info)
            end
        end
    end

    RefreshGameList("")

    local function DoSearch()
        RefreshGameList(SearchBox.Text or "")
    end

    SearchButton.MouseButton1Click:Connect(DoSearch)
    SearchBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            DoSearch()
        end
    end)

    -- other pages
    Pages.Combat = CreatePage()
    Pages.Visuals = CreatePage()
    Pages.Misc = CreatePage()

    local function simpleLabel(page, text)
        local L = Instance.new("TextLabel")
        L.Position = UDim2.new(0, 8, 0, 8)
        L.Size = UDim2.new(1, -16, 0, 24)
        L.BackgroundTransparency = 1
        L.Font = Enum.Font.GothamBold
        L.Text = text
        L.TextColor3 = Color3.fromRGB(230, 230, 240)
        L.TextSize = 18
        L.TextXAlignment = Enum.TextXAlignment.Left
        L.Parent = page
    end

    simpleLabel(Pages.Combat, "Combat settings coming soon.")

    -- VISUALS PAGE + controls
    local VisualsTitle = Instance.new("TextLabel")
    VisualsTitle.Position = UDim2.new(0, 8, 0, 8)
    VisualsTitle.Size = UDim2.new(1, -16, 0, 24)
    VisualsTitle.BackgroundTransparency = 1
    VisualsTitle.Font = Enum.Font.GothamBold
    VisualsTitle.Text = "Visuals / ESP"
    VisualsTitle.TextColor3 = Color3.fromRGB(230, 230, 240)
    VisualsTitle.TextSize = 18
    VisualsTitle.TextXAlignment = Enum.TextXAlignment.Left
    VisualsTitle.Parent = Pages.Visuals

    local VisualsSub = Instance.new("TextLabel")
    VisualsSub.Position = UDim2.new(0, 8, 0, 32)
    VisualsSub.Size = UDim2.new(1, -16, 0, 18)
    VisualsSub.BackgroundTransparency = 1
    VisualsSub.Font = Enum.Font.Gotham
    VisualsSub.Text = "Toggle ESP and tweak colors/transparency."
    VisualsSub.TextColor3 = Color3.fromRGB(150, 150, 165)
    VisualsSub.TextSize = 13
    VisualsSub.TextXAlignment = Enum.TextXAlignment.Left
    VisualsSub.Parent = Pages.Visuals

    local HighlightButton = Instance.new("TextButton")
    HighlightButton.Position = UDim2.new(0, 8, 0, 60)
    HighlightButton.Size = UDim2.new(0, 220, 0, 32)
    HighlightButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    HighlightButton.BorderSizePixel = 0
    HighlightButton.Font = Enum.Font.GothamBold
    HighlightButton.Text = "Highlight Players: OFF"
    HighlightButton.TextColor3 = Color3.fromRGB(230, 230, 240)
    HighlightButton.TextSize = 14
    HighlightButton.Parent = Pages.Visuals

    local HighlightCorner = Instance.new("UICorner")
    HighlightCorner.CornerRadius = UDim.new(0, 8)
    HighlightCorner.Parent = HighlightButton

    local NameESPButton = Instance.new("TextButton")
    NameESPButton.Position = UDim2.new(0, 8, 0, 100)
    NameESPButton.Size = UDim2.new(0, 220, 0, 32)
    NameESPButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    NameESPButton.BorderSizePixel = 0
    NameESPButton.Font = Enum.Font.GothamBold
    NameESPButton.Text = "Show Names: OFF"
    NameESPButton.TextColor3 = Color3.fromRGB(230, 230, 240)
    NameESPButton.TextSize = 14
    NameESPButton.Parent = Pages.Visuals

    local NameESPCorner = Instance.new("UICorner")
    NameESPCorner.CornerRadius = UDim.new(0, 8)
    NameESPCorner.Parent = NameESPButton

    local rVal, gVal, bVal = 130, 255, 130
    local nrVal, ngVal, nbVal = 130, 255, 130

    makeSliderRow(Pages.Visuals, 140, "Highlight R", rVal, function(v)
        rVal = v
        highlightColor = sliderToColor(rVal, gVal, bVal)
    end)

    makeSliderRow(Pages.Visuals, 170, "Highlight G", gVal, function(v)
        gVal = v
        highlightColor = sliderToColor(rVal, gVal, bVal)
    end)

    makeSliderRow(Pages.Visuals, 200, "Highlight B", bVal, function(v)
        bVal = v
        highlightColor = sliderToColor(rVal, gVal, bVal)
    end)

    makeSliderRow(Pages.Visuals, 230, "Name R", nrVal, function(v)
        nrVal = v
        nameColor = sliderToColor(nrVal, ngVal, nbVal)
    end)

    makeSliderRow(Pages.Visuals, 260, "Name G", ngVal, function(v)
        ngVal = v
        nameColor = sliderToColor(nrVal, ngVal, nbVal)
    end)

    makeSliderRow(Pages.Visuals, 290, "Name B", nbVal, function(v)
        nbVal = v
        nameColor = sliderToColor(nrVal, ngVal, nbVal)
    end)

    makeAlphaRow(Pages.Visuals, 320, "Highlight Fill Transparency", math.floor(highlightFillTransparency * 100), function(a)
        highlightFillTransparency = a
    end)

    makeAlphaRow(Pages.Visuals, 350, "Highlight Outline Transparency", math.floor(highlightOutlineTransparency * 100), function(a)
        highlightOutlineTransparency = a
    end)

    -- Visuals logic
    local highlightsEnabled = false
    local namesEnabled = false
    local highlightFolder = Instance.new("Folder")
    highlightFolder.Name = "ScriptHub_Highlights"
    highlightFolder.Parent = ScreenGui

    local nameGuiFolder = Instance.new("Folder")
    nameGuiFolder.Name = "ScriptHub_NameESP"
    nameGuiFolder.Parent = ScreenGui

    local function clearHighlights()
        for _, h in ipairs(highlightFolder:GetChildren()) do
            if h:IsA("Highlight") then
                h:Destroy()
            end
        end
    end

    local function clearNameESP()
        for _, b in ipairs(nameGuiFolder:GetChildren()) do
            if b:IsA("BillboardGui") then
                b:Destroy()
            end
        end
    end

    local function createHighlightForCharacter(char)
        if not highlightsEnabled then return end
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end
        local existing = highlightFolder:FindFirstChild(char.Name .. "_HL")
        if existing then
            existing.FillColor = highlightColor
            existing.FillTransparency = highlightFillTransparency
            existing.OutlineTransparency = highlightOutlineTransparency
            return
        end
        local hl = Instance.new("Highlight")
        hl.Name = char.Name .. "_HL"
        hl.FillColor = highlightColor
        hl.OutlineColor = Color3.fromRGB(0, 0, 0)
        hl.FillTransparency = highlightFillTransparency
        hl.OutlineTransparency = highlightOutlineTransparency
        hl.Adornee = char
        hl.Parent = highlightFolder
    end

    local function createNameESPForCharacter(char, plr)
        if not namesEnabled then return end
        if not char or not char:FindFirstChild("Head") then return end
        local existing = nameGuiFolder:FindFirstChild(char.Name .. "_NameESP")
        if existing then
            local label = existing:FindFirstChildOfClass("TextLabel")
            if label then
                label.TextColor3 = nameColor
            end
            return
        end
        local head = char:FindFirstChild("Head")
        local bill = Instance.new("BillboardGui")
        bill.Name = char.Name .. "_NameESP"
        bill.Adornee = head
        bill.Size = UDim2.new(0, 200, 0, 50)
        bill.StudsOffset = Vector3.new(0, 3, 0)
        bill.AlwaysOnTop = true
        bill.Parent = nameGuiFolder

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.GothamBold
        label.Text = plr.Name
        label.TextColor3 = nameColor
        label.TextStrokeTransparency = 0
        label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
        label.TextSize = 14
        label.Parent = bill
    end

    local function refreshPlayerVisuals()
        clearHighlights()
        clearNameESP()
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer then
                local char = plr.Character
                if char then
                    if highlightsEnabled then
                        createHighlightForCharacter(char)
                    end
                    if namesEnabled then
                        createNameESPForCharacter(char, plr)
                    end
                end
            end
        end
    end

    Players.PlayerAdded:Connect(function(plr)
        plr.CharacterAdded:Connect(function(char)
            task.wait(0.2)
            if highlightsEnabled then
                createHighlightForCharacter(char)
            end
            if namesEnabled then
                createNameESPForCharacter(char, plr)
            end
        end)
    end)

    Players.PlayerRemoving:Connect(function(plr)
        local h = highlightFolder:FindFirstChild(plr.Name .. "_HL")
        if h then h:Destroy() end
        local b = nameGuiFolder:FindFirstChild(plr.Name .. "_NameESP")
        if b then b:Destroy() end
    end)

    HighlightButton.MouseButton1Click:Connect(function()
        highlightsEnabled = not highlightsEnabled
        if highlightsEnabled then
            HighlightButton.Text = "Highlight Players: ON"
            HighlightButton.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
        else
            HighlightButton.Text = "Highlight Players: OFF"
            HighlightButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            clearHighlights()
        end
        refreshPlayerVisuals()
    end)

    NameESPButton.MouseButton1Click:Connect(function()
        namesEnabled = not namesEnabled
        if namesEnabled then
            NameESPButton.Text = "Show Names: ON"
            NameESPButton.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
        else
            NameESPButton.Text = "Show Names: OFF"
            NameESPButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            clearNameESP()
        end
        refreshPlayerVisuals()
    end)

    -- Misc page with Infinite Yield loader
    local MiscTitle = Instance.new("TextLabel")
    MiscTitle.Position = UDim2.new(0, 8, 0, 8)
    MiscTitle.Size = UDim2.new(1, -16, 0, 24)
    MiscTitle.BackgroundTransparency = 1
    MiscTitle.Font = Enum.Font.GothamBold
    MiscTitle.Text = "Miscellaneous Utilities"
    MiscTitle.TextColor3 = Color3.fromRGB(230, 230, 240)
    MiscTitle.TextSize = 18
    MiscTitle.TextXAlignment = Enum.TextXAlignment.Left
    MiscTitle.Parent = Pages.Misc

    local MiscSub = Instance.new("TextLabel")
    MiscSub.Position = UDim2.new(0, 8, 0, 32)
    MiscSub.Size = UDim2.new(1, -16, 0, 18)
    MiscSub.BackgroundTransparency = 1
    MiscSub.Font = Enum.Font.Gotham
    MiscSub.Text = "Quick utilities for the current game."
    MiscSub.TextColor3 = Color3.fromRGB(150, 150, 165)
    MiscSub.TextSize = 13
    MiscSub.TextXAlignment = Enum.TextXAlignment.Left
    MiscSub.Parent = Pages.Misc

    local IYButton = Instance.new("TextButton")
    IYButton.Position = UDim2.new(0, 8, 0, 60)
    IYButton.Size = UDim2.new(0, 220, 0, 36)
    IYButton.BackgroundColor3 = Color3.fromRGB(130, 255, 130)
    IYButton.BorderSizePixel = 0
    IYButton.Font = Enum.Font.GothamBold
    IYButton.Text = "Load Infinite Yield"
    IYButton.TextColor3 = Color3.fromRGB(10, 20, 10)
    IYButton.TextSize = 14
    IYButton.Parent = Pages.Misc

    local IYCorner = Instance.new("UICorner")
    IYCorner.CornerRadius = UDim.new(0, 8)
    IYCorner.Parent = IYButton

    local IYStatus = Instance.new("TextLabel")
    IYStatus.Position = UDim2.new(0, 8, 0, 100)
    IYStatus.Size = UDim2.new(1, -16, 0, 18)
    IYStatus.BackgroundTransparency = 1
    IYStatus.Font = Enum.Font.Gotham
    IYStatus.Text = ""
    IYStatus.TextColor3 = Color3.fromRGB(150, 150, 165)
    IYStatus.TextSize = 13
    IYStatus.TextXAlignment = Enum.TextXAlignment.Left
    IYStatus.Parent = Pages.Misc

    IYButton.MouseButton1Click:Connect(function()
        IYStatus.Text = "Loading Infinite Yield..."
        IYStatus.TextColor3 = Color3.fromRGB(200, 200, 120)
        task.spawn(function()
            local ok, err = pcall(function()
                loadstring(game:HttpGet("https://rawscripts.net/raw/Universal-Script-Infinite-Yield-43437"))()
            end)
            if ok then
                IYStatus.Text = "Infinite Yield loaded successfully."
                IYStatus.TextColor3 = Color3.fromRGB(100, 255, 100)
            else
                IYStatus.Text = "Failed to load Infinite Yield: " .. tostring(err)
                IYStatus.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
        end)
    end)

    -- tab wiring
    Tabs.Loader.MouseButton1Click:Connect(function() SwitchTo("Loader") end)
    Tabs.Combat.MouseButton1Click:Connect(function() SwitchTo("Combat") end)
    Tabs.Visuals.MouseButton1Click:Connect(function() SwitchTo("Visuals") end)
    Tabs.Misc.MouseButton1Click:Connect(function() SwitchTo("Misc") end)

    SwitchTo("Loader")

    local minimized = false
    local originalSize = Window.Size

    MinimizeButton.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            ContentHolder.Visible = false
            Resizer.Visible = false
            TweenService:Create(Window, TweenInfo.new(0.2), {
                Size = UDim2.new(0, originalSize.X.Offset, 0, 36)
            }):Play()
        else
            TweenService:Create(Window, TweenInfo.new(0.2), {
                Size = originalSize
            }):Play()
            task.wait(0.2)
            ContentHolder.Visible = true
            Resizer.Visible = true
        end
    end)

    CloseButton.MouseButton1Click:Connect(function()
        clearHighlights()
        clearNameESP()
        ScreenGui:Destroy()
    end)

    Window.Size = UDim2.new(0, 0, 0, 0)
    Window.AnchorPoint = Vector2.new(0.5, 0.5)
    Window.Position = UDim2.new(0.5, 0, 0.5, 0)

    TweenService:Create(Window, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, originalSize.X.Offset, 0, originalSize.Y.Offset)
    }):Play()

    Window.AnchorPoint = Vector2.new(0.5, 0.5)

    return ScreenGui
end


-- =========================
-- Auth UI (key input)
-- =========================
local function CreateKeySystemUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "KeySystemUI_" .. math.random(10000, 99999)
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn = false
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.Parent = game:GetService("CoreGui")

    local Blur = Instance.new("Frame")
    Blur.Size = UDim2.new(1, 0, 1, 0)
    Blur.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
    Blur.BorderSizePixel = 0
    Blur.BackgroundTransparency = 0.25
    Blur.Parent = ScreenGui

    local Container = Instance.new("Frame")
    Container.AnchorPoint = Vector2.new(0.5, 0.5)
    Container.Position = UDim2.new(0.5, 0, 0.5, 0)
    Container.Size = UDim2.new(0, 450, 0, 320)
    Container.BackgroundColor3 = Color3.fromRGB(28, 28, 38)
    Container.BorderSizePixel = 0
    Container.Parent = ScreenGui

    local ContainerCorner = Instance.new("UICorner")
    ContainerCorner.CornerRadius = UDim.new(0, 16)
    ContainerCorner.Parent = Container

    local TopAccent = Instance.new("Frame")
    TopAccent.Size = UDim2.new(1, 0, 0, 5)
    TopAccent.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    TopAccent.BorderSizePixel = 0
    TopAccent.Parent = Container

    local Icon = Instance.new("Frame")
    Icon.Size = UDim2.new(0, 70, 0, 70)
    Icon.Position = UDim2.new(0.5, 0, 0, 30)
    Icon.AnchorPoint = Vector2.new(0.5, 0)
    Icon.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    Icon.BorderSizePixel = 0
    Icon.Parent = Container

    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(0, 14)
    IconCorner.Parent = Icon

    local IconText = Instance.new("TextLabel")
    IconText.Size = UDim2.new(1, 0, 1, 0)
    IconText.BackgroundTransparency = 1
    IconText.Font = Enum.Font.GothamBold
    IconText.Text = "üîê"
    IconText.TextColor3 = Color3.fromRGB(255, 255, 255)
    IconText.TextSize = 36
    IconText.Parent = Icon

    local Title = Instance.new("TextLabel")
    Title.Position = UDim2.new(0.5, 0, 0, 115)
    Title.Size = UDim2.new(0.9, 0, 0, 35)
    Title.AnchorPoint = Vector2.new(0.5, 0)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.Text = "ScriptHub Authentication"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 22
    Title.Parent = Container

    local Subtitle = Instance.new("TextLabel")
    Subtitle.Position = UDim2.new(0.5, 0, 0, 150)
    Subtitle.Size = UDim2.new(0.9, 0, 0, 20)
    Subtitle.AnchorPoint = Vector2.new(0.5, 0)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Font = Enum.Font.Gotham
    Subtitle.Text = "Enter your key to access ScriptHub"
    Subtitle.TextColor3 = Color3.fromRGB(150, 150, 165)
    Subtitle.TextSize = 13
    Subtitle.Parent = Container

    local InputContainer = Instance.new("Frame")
    InputContainer.Position = UDim2.new(0.5, 0, 0, 190)
    InputContainer.Size = UDim2.new(0, 390, 0, 50)
    InputContainer.AnchorPoint = Vector2.new(0.5, 0)
    InputContainer.BackgroundColor3 = Color3.fromRGB(38, 38, 48)
    InputContainer.BorderSizePixel = 0
    InputContainer.Parent = Container

    local InputCorner = Instance.new("UICorner")
    InputCorner.CornerRadius = UDim.new(0, 10)
    InputCorner.Parent = InputContainer

    local InputStroke = Instance.new("UIStroke")
    InputStroke.Color = Color3.fromRGB(60, 60, 75)
    InputStroke.Thickness = 2
    InputStroke.Parent = InputContainer

    local InputBox = Instance.new("TextBox")
    InputBox.Size = UDim2.new(1, -20, 1, 0)
    InputBox.Position = UDim2.new(0, 10, 0, 0)
    InputBox.BackgroundTransparency = 1
    InputBox.Font = Enum.Font.GothamMedium
    InputBox.PlaceholderText = "SH-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
    InputBox.PlaceholderColor3 = Color3.fromRGB(100, 100, 120)
    InputBox.Text = ""
    InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    InputBox.TextSize = 14
    InputBox.TextXAlignment = Enum.TextXAlignment.Left
    InputBox.ClearTextOnFocus = false
    InputBox.Parent = InputContainer

    InputBox.Focused:Connect(function()
        TweenService:Create(InputStroke, TweenInfo.new(0.2), {
            Color = Color3.fromRGB(88, 101, 242),
            Thickness = 3
        }):Play()
    end)

    InputBox.FocusLost:Connect(function()
        TweenService:Create(InputStroke, TweenInfo.new(0.2), {
            Color = Color3.fromRGB(60, 60, 75),
            Thickness = 2
        }):Play()
    end)

    local SubmitButton = Instance.new("TextButton")
    SubmitButton.Position = UDim2.new(0.5, 0, 0, 260)
    SubmitButton.Size = UDim2.new(0, 390, 0, 50)
    SubmitButton.AnchorPoint = Vector2.new(0.5, 0)
    SubmitButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    SubmitButton.BorderSizePixel = 0
    SubmitButton.Font = Enum.Font.GothamBold
    SubmitButton.Text = "Verify Key"
    SubmitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    SubmitButton.TextSize = 16
    SubmitButton.AutoButtonColor = false
    SubmitButton.Parent = Container

    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 10)
    ButtonCorner.Parent = SubmitButton

    SubmitButton.MouseEnter:Connect(function()
        TweenService:Create(SubmitButton, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(98, 111, 252),
            Size = UDim2.new(0, 395, 0, 52)
        }):Play()
    end)

    SubmitButton.MouseLeave:Connect(function()
        TweenService:Create(SubmitButton, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(88, 101, 242),
            Size = UDim2.new(0, 390, 0, 50)
        }):Play()
    end)

    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Position = UDim2.new(0.5, 0, 1, -15)
    StatusLabel.Size = UDim2.new(0.9, 0, 0, 20)
    StatusLabel.AnchorPoint = Vector2.new(0.5, 1)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Font = Enum.Font.GothamMedium
    StatusLabel.Text = ""
    StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    StatusLabel.TextSize = 13
    StatusLabel.Visible = false
    StatusLabel.Parent = Container

    -- entrance
    Container.Size = UDim2.new(0, 0, 0, 0)
    Container.Rotation = 10
    TweenService:Create(Container, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 450, 0, 320),
        Rotation = 0
    }):Play()

    return ScreenGui, InputBox, SubmitButton, StatusLabel, Container, Subtitle
end

-- =========================
-- Main Script Loader
-- =========================
local function LoadMainScript(isAdmin)
    print("üéØ Loading main script, admin:", isAdmin)

    if isAdmin then
        -- Admins can see both admin panel and hub if you want.
        CreateAdminPanel()
        CreateScriptHubUI()
    else
        -- Regular key: only script hub UI
        CreateScriptHubUI()
    end
end

-- F9: force open admin panel (admin-only visual)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.F9 then
        print("üîë F9 pressed - opening admin panel...")
        CreateAdminPanel()
    end
end)

-- =========================
-- Main Execution
-- =========================
print("üîç Checking for active key...")
print("‚öôÔ∏è Server URL:", Server_URL)
print("üíæ HWID:", HWID)

local hasActiveKey, keyType, isAdmin = CheckActiveKey()
print("üìù Active check:", hasActiveKey, keyType, isAdmin)

-- If game is unsupported and user is NOT admin, block usage
if not IsSupportedGame() and not isAdmin then
    warn("üö´ Unsupported game for regular users. PlaceId:", game.PlaceId)
    local msg = Instance.new("Message")
    msg.Text = "This game is not supported by ScriptHub yet."
    msg.Parent = workspace
    task.delay(5, function() msg:Destroy() end)
    -- do not continue into UI
    return
end

if hasActiveKey then
    print("‚úÖ Auto-authenticated! Admin:", isAdmin)
    LoadMainScript(isAdmin or false)
    return
end

print("‚ö†Ô∏è No active key found; showing key UI...")

local KeySystemUI, InputBox, SubmitButton, StatusLabel, Container, Subtitle = CreateKeySystemUI()
local isVerifying = false

local function ShowStatus(text, isSuccess)
    StatusLabel.Text = text
    StatusLabel.TextColor3 = isSuccess and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    StatusLabel.Visible = true
    StatusLabel.TextTransparency = 1
    TweenService:Create(StatusLabel, TweenInfo.new(0.3), {
        TextTransparency = 0
    }):Play()
end

local function AttemptVerification()
    if isVerifying then return end
    local key = InputBox.Text

    if key == "" or #key < 5 then
        ShowStatus("‚ùå Please enter a valid key", false)

        local originalPos = Container.Position
        for _ = 1, 3 do
            TweenService:Create(Container, TweenInfo.new(0.05), {Position = originalPos + UDim2.new(0, 10, 0, 0)}):Play()
            task.wait(0.05)
            TweenService:Create(Container, TweenInfo.new(0.05), {Position = originalPos - UDim2.new(0, 10, 0, 0)}):Play()
            task.wait(0.05)
        end
        TweenService:Create(Container, TweenInfo.new(0.05), {Position = originalPos}):Play()
        return
    end

    isVerifying = true
    SubmitButton.Text = "Verifying..."
    SubmitButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    Subtitle.Text = "Please wait while we verify your key..."

    task.spawn(function()
        local dots = 0
        while isVerifying do
            dots = (dots % 3) + 1
            SubmitButton.Text = "Verifying" .. string.rep(".", dots)
            task.wait(0.4)
        end
    end)

    local valid, message, adminKey = VerifyKey(key)
    isVerifying = false
    print("üß™ Verification:", valid, message, adminKey)

    -- Non-admins cannot auth in unsupported games
    if valid and not adminKey and not IsSupportedGame() then
        ShowStatus("üö´ This game is not supported for regular keys.", false)
        SubmitButton.Text = "Verify Key"
        SubmitButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
        Subtitle.Text = "Please join a supported game or use an admin key."
        return
    end

    if valid then
        ShowStatus("‚úÖ Key verified! Loading hub...", true)
        SubmitButton.Text = adminKey and "Admin Access Granted!" or "Success!"
        SubmitButton.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
        Subtitle.Text = adminKey and "Admin authentication successful!" or "Authentication successful!"

        TweenService:Create(Container, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(40, 60, 50)
        }):Play()

        task.wait(1.2)

        local closeTween = TweenService:Create(Container, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Rotation = -10
        })
        closeTween:Play()
        closeTween.Completed:Wait()
        KeySystemUI:Destroy()

        LoadMainScript(adminKey or false)
    else
        ShowStatus("‚ùå " .. (message or "Invalid key"), false)
        SubmitButton.Text = "Verify Key"
        SubmitButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
        Subtitle.Text = "Please check your key and try again..."

        local originalPos = Container.Position
        for _ = 1, 4 do
            TweenService:Create(Container, TweenInfo.new(0.05), {Position = originalPos + UDim2.new(0, 15, 0, 0)}):Play()
            task.wait(0.05)
            TweenService:Create(Container, TweenInfo.new(0.05), {Position = originalPos - UDim2.new(0, 15, 0, 0)}):Play()
            task.wait(0.05)
        end
        TweenService:Create(Container, TweenInfo.new(0.1), {Position = originalPos}):Play()
    end
end

SubmitButton.MouseButton1Click:Connect(AttemptVerification)
InputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        AttemptVerification()
    end
end)
